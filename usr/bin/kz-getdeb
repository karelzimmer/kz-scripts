#!/bin/bash
# shellcheck source=kz_common.sh
###############################################################################
# Install kz package.
#
# Written in 2016 by Karel Zimmer <info@karelzimmer.nl>, Creative Commons
# Public Domain Dedication <http://creativecommons.org/publicdomain/zero/1.0>.
###############################################################################

set -o errexit
source <(wget --quiet --output-document=- \
        'https://karelzimmer.nl/data/linux/kz-scripts/usr/bin/kz_common.sh')


###############################################################################
# Constants
###############################################################################

declare program_name='kz-getdeb'
declare program_desc
program_desc=$(gettext 'Install kz package.')
declare display_name=${program_name/kz-/kz }

declare usage
usage=$(eval_gettext "Usage: \$display_name \$options_usage")
declare help
help="$(eval_gettext "Usage: \$display_name [OPTION...]")

$program_desc.

$(gettext 'Options:')
$options_help"


###############################################################################
# Variables
###############################################################################


###############################################################################
# Functions
###############################################################################

function check_input {
    local -i getopt_rc=0
    local parsed=''

    parsed=$(
        getopt  --alternative                       \
                --options       "$options_short"    \
                --longoptions   "$options_long"     \
                --name          "$display_name"     \
                --              "$@"
        ) || getopt_rc=$?
    if [[ $getopt_rc -ne $ok ]]; then
        info "$usage_line"
        exit $err
    fi
    eval set -- "$parsed"
    kz_common.process_options "$@"

    while true; do
        case $1 in
            --)
                shift
                break
                ;;
            *)
                shift
                ;;
        esac
    done

    if [[ "$*" ]]; then
        printf  "$display_name: $*: %s\n$usage_line\n" \
                "$(gettext 'arguments are not allowed')"
        exit $err
    fi

    kz_common.check_on_ac_power
    clear -x
    if ! kz_common.check_user_sudo; then
        term_script
    fi
}


function process_input {
    install_package
}


function install_package {
    local site_deb='https://karelzimmer.nl/downloads/kz/kz_365_all.deb'
    local temp_deb=''

    check_user_root

    title=$(gettext 'Progress')
    text=$(gettext 'Install package kz (may take a while)...')
    TERM=ansi whiptail  --backtitle "$display_name" \
                        --title     "$title"        \
                        --infobox   "$text"         \
                        7 44

    # Bij Ubuntu Live sessie de universe repo aanzetten.
    if  [[ $HOSTNAME = 'ubuntu' && $USER = 'ubuntu' ]]; then
        kz_common.check_dpkgd_snapd
        sudo apt-add-repository --yes universe  |& $logcmd
        kz_common.check_dpkgd_snapd
        sudo apt-get update |& $logcmd
    fi

    # Installeer pakket kz.
    temp_deb=$(mktemp -t "$program_name-XXXXXXXXXX.deb")
    wget --output-document="$temp_deb" $site_deb |& $logcmd
    kz_common.check_dpkgd_snapd
    sudo    DEBIAN_FRONTEND=noninteractive  \
            apt-get                         \
            reinstall                       \
            --yes                           \
            "$temp_deb"                     |& $logcmd
    rm "$temp_deb" |& $logcmd
}


function check_user_root {
    if ! sudo -n true 2> >($logcmd); then
        while true; do
            title=$(gettext 'Need authentication')
            text="
$(gettext 'Authentication is required to install
package kz with documents and scripts
from Karel Zimmer.

Enter your password:')"
            # Construction '3>&1 1>&2 2>&3' to swap stdout and stderr.
            if printf '%s\n' "$(
                whiptail    --backtitle     "$display_name"         \
                            --title         "$title"                \
                            --ok-button     "$(gettext 'Verify')"   \
                            --cancel-button "$(gettext 'Cancel')"   \
                            --passwordbox   "$text"                 \
                            13 41                                   \
                            3>&1 1>&2 2>&3
                )" | sudo --stdin true 2> >($logcmd); then
                break
            else
                title=$(gettext 'Error')
                text=$(gettext 'An error has occurred.

Possible cause:
1. No or incorrect password entered
2. <Cancel> was selected on the previous screen')
                if ! whiptail   --backtitle     "$display_name"         \
                                --title         "$title"                \
                                --yes-button    "$(gettext 'Again')"    \
                                --no-button     "$(gettext 'Stop')"     \
                                --yesno         "$text"                 \
                                11 51; then
                    title=$(gettext 'Stopped')
                    text=$(gettext 'Program has been stopped by the user')
                    TERM=ansi whiptail  --backtitle "$display_name" \
                                        --title     "$title"        \
                                        --infobox   "$text"         \
                                        7 42
                    exit $err
                fi
            fi
        done
    fi
}


function term_script {
    title=$(gettext 'Finished')
    text=$(gettext "Package kz has been successfully installed.

Now follow the steps as described
in the Installation Checklist.

Checklist installation can be found
on the site https://karelzimmer.nl,
under Linux.

Type 'exit' to close this window.")
    TERM=ansi whiptail  --backtitle "$display_name" \
                        --title     "$title"        \
                        --infobox   "$text"         \
                        16 47
    if kz_common.developer check; then
        info "$(gettext '* DEVELOPER *')"
        check_dependencies
        download_website
        pull_repos
        info '* status repos (gitstat)...'
        /home/"$USER"/bin/gitstat
    fi
    exit $ok
}


function check_dependencies {
    local escape='gettext'

    info "$(gettext '* check dependencies...')"
    # Install ghostscript for kz-build <man-pag>.pdf (ps2pdf).
    kz_common.check_dpkgd_snapd
    # Remove known lines from output.
    sudo    apt-get                                 \
            install                                 \
            --yes                                   \
            curl                                    \
            fakeroot                                \
            $escape                                 \
            ghostscript                             \
            git                                     \
            jq                                      \
            lftp                                    \
            nmap                                    \
            pycodestyle                             \
            python3-pycodestyle                     \
            python3-autopep8                        \
            python3-pip                             \
            python-is-python3                       \
            w3c-linkchecker                         |
            sed '/ is reeds de nieuwste versie /d'  |
            sed '/ is already the newest version /d'
    sudo ln --force --relative --symbolic /usr/bin/pycodestyle /usr/bin/pep8
    sudo ln --force --relative --symbolic /usr/bin/pip3 /usr/bin/pip
    # Debian package is old, snap is newer.
    kz_common.check_dpkgd_snapd
    sudo snap install shellcheck |& $logcmd
    kz_common.check_dpkgd_snapd
    sudo snap install --classic code |& $logcmd
}


function download_website {
    local ftp_set='set ssl:verify-certificate no'
    local ftp_from=/httpdocs
    local ftp_to=$HOME/kz-uploads/dist
    local ftp_opts='--delete --verbose'
    local ftp_exclude='--exclude icaclient_20.04.0.21_amd64.deb'
    local ftp_cmd="mirror $ftp_exclude $ftp_opts $ftp_from $ftp_to; exit"
    local ftp_host=server106.hosting2go.nl
    local ftp_user=kzimmer
    local ftp_login=$HOME/.kz-$ftp_host

    info '* download website (lftp)...'
    if ! [[ -f $ftp_login ]]; then
        # < /dev/tty want FD 1 al in gebruik bij 'wget --output-document=-...'.
        read -rsp "$(gettext 'Password for') ftp://$ftp_host': " < /dev/tty
        printf '%s\n' "$REPLY" > "$ftp_login"
        printf '\n'
        chmod 'u=rw,g=,o=' "$ftp_login"
    fi
    if ! lftp   --user "$ftp_user"                  \
                --password "$(cat "$ftp_login")"    \
                -e "$ftp_set; $ftp_cmd"             \
                "$ftp_host"; then
        rm  "$ftp_login"
        info "$(gettext 'Website download failed.')"
        return  $err
    fi
}


function pull_repos {
    local bin_repo=/home/"$USER"/bin

    git config --global user.name 'Karel Zimmer'
    git config --global user.email 'karel.zimmer@gmail.com'
    git config --global pull.ff only
    git config --global credential.helper store
    if ! git    clone                                   \
                https://github.com/karelzimmer/bin.git  \
                "$bin_repo"                             2> >($logcmd); then
        cd "$bin_repo"
        printf  "%s\n" "$(gettext '* initial pull bin repo...')"
        # Remove known line from output.
        git pull | sed '/Already up to date./d'
    fi
    info '* pull repos (gitpull)...'
    "$bin_repo"/gitpull
}


###############################################################################
# Script
###############################################################################

function main {
    kz_common.init_script "$@"
    check_input "$@"
    process_input
    term_script
}

main "$@"
