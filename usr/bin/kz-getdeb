#!/bin/bash
# shellcheck shell=bash
###############################################################################
# Install kz package.
#
# Written in 2016 by Karel Zimmer <info@karelzimmer.nl>, Creative Commons
# Public Domain Dedication <https://creativecommons.org/publicdomain/zero/1.0>.
###############################################################################


###############################################################################
# Constants
###############################################################################


###############################################################################
# Variables
###############################################################################


###############################################################################
# Functions
###############################################################################

function init_script {
    set -o errexit
    set -o errtrace
    set -o nounset
    set -o pipefail

    export TEXTDOMAIN=kz
    export TEXTDOMAINDIR=/usr/share/locale

    # shellcheck source=/dev/null
    source /usr/bin/gettext.sh
}


function check_input {
    if ! sudo true; then
        term_script
    fi
}


function process_input {
    update_system
    install_package
}


function update_system {
    # Repair.
    check_dpkgd_snapd
    sudo dpkg --configure --pending
    check_dpkgd_snapd
    sudo apt-get update --fix-missing
    check_dpkgd_snapd
    sudo apt-get install --fix-broken
    # Update.
    check_dpkgd_snapd
    sudo apt-get update
    check_dpkgd_snapd
    sudo apt-get upgrade --yes
}


function check_dpkgd_snapd {
    local -i dpkg_wait=10
    local text
    text=$(eval_gettext \
            "Wait \${dpkg_wait}s for another package manager to finish...")

    if find /snap/core/*/var/cache/debconf/config.dat &> /dev/null; then
        # System with snaps.
        while sudo  fuser                                               \
                    /var/{lib/{dpkg,apt/lists},cache/apt/archives}/lock \
                    /var/cache/debconf/config.dat                       \
                    /snap/core/*/var/cache/debconf/config.dat           \
                    &> /dev/null; do
            printf '%s\n' "$text"
            sleep $dpkg_wait
        done
    else
        # System without snaps.
        while sudo  fuser                                               \
                    /var/{lib/{dpkg,apt/lists},cache/apt/archives}/lock \
                    /var/cache/debconf/config.dat                       \
                    &> /dev/null; do
            printf '%s\n' "$text"
            sleep $dpkg_wait
        done
    fi
}


function install_package {
    local site_deb='https://karelzimmer.nl/downloads/kz/kz_365_all.deb'
    local temp_deb=''

    temp_deb=$(mktemp -t 'kz-XXXXXXXXXX.deb')
    # Prevent: N: ... user '_apt'. - pkgAcquire::Run (13: Permission denied)
    chmod o+r "$temp_deb"
    wget --output-document="$temp_deb" $site_deb
    check_dpkgd_snapd
    sudo    DEBIAN_FRONTEND=noninteractive  \
            apt-get                         \
            reinstall                       \
            --yes                           \
            "$temp_deb"
    rm "$temp_deb"
}


function term_script {
    printf '%s\n' "

$(gettext "Package kz has been successfully installed.

Now follow the steps as described
in the Installation Checklist.

Checklist installation can be found
on the site https://karelzimmer.nl,
under Linux.

Type 'exit' to close this window.")"
    if [[ $USER = 'karel' && $HOSTNAME = pc[0-9][0-9] ]]; then
        printf '%s\n' "$(gettext '* DEVELOPER *')"
        check_dependencies
        download_website
        pull_repos
        printf '%s\n' '* status repos (gitstat)...'
        /home/"$USER"/bin/gitstat
    fi

    # Do not delete kz and kz.1 due to scripts and manuals with the same name.
    rm --force kz.{2..99}
    # But do delete them if in HOME, as described in Checklist install.
    cd "$HOME" || exit 1
    rm --force kz kz.1

    exit 0
}


function check_dependencies {
    local escape='gettext'

    printf '%s\n' "$(gettext '* check dependencies...')"
    # Install ghostscript for kz-build <man-pag>.pdf (ps2pdf) and remove known
    # lines from output.
    check_dpkgd_snapd
    sudo    apt-get                                 \
            install                                 \
            --yes                                   \
            curl                                    \
            fakeroot                                \
            $escape                                 \
            ghostscript                             \
            git                                     \
            jq                                      \
            lftp                                    \
            nmap                                    \
            pycodestyle                             \
            python3-pycodestyle                     \
            python3-autopep8                        \
            python3-pip                             \
            python-is-python3                       |
            sed '/ is reeds de nieuwste versie /d'  |
            sed '/ is already the newest version /d'
    sudo ln --force --relative --symbolic /usr/bin/pycodestyle /usr/bin/pep8
    sudo ln --force --relative --symbolic /usr/bin/pip3 /usr/bin/pip
    # Debian packages are old, snap is newer and remove known lines from
    # output.
    check_dpkgd_snapd
    sudo snap install shellcheck | sed '/is already installed/d'
    check_dpkgd_snapd
    sudo snap install --classic code | sed '/is already installed/d'
}


function download_website {
    local ftp_set='set ssl:verify-certificate no'
    local ftp_from=/httpdocs
    local ftp_to=$HOME/kz-uploads/dist
    local ftp_opts='--delete --verbose'
    local ftp_exclude='--exclude icaclient_20.04.0.21_amd64.deb'
    local ftp_cmd="mirror $ftp_exclude $ftp_opts $ftp_from $ftp_to; exit"
    local ftp_host=server106.hosting2go.nl
    local ftp_user=kzimmer
    local ftp_login=$HOME/.kz-$ftp_host

    printf '%s\n' '* download website (lftp)...'
    if ! [[ -f $ftp_login ]]; then
        read -rsp "$(gettext 'Password for') ftp://$ftp_host': " < /dev/tty
        printf '%s\n' "$REPLY" > "$ftp_login"
        printf '\n'
        chmod 'u=rw,g=,o=' "$ftp_login"
    fi
    if ! lftp   --user "$ftp_user"                  \
                --password "$(cat "$ftp_login")"    \
                -e "$ftp_set; $ftp_cmd"             \
                "$ftp_host"; then
        rm  "$ftp_login"
        printf '%s\n' "$(gettext 'Website download failed.')"
        return  1
    fi
}


function pull_repos {
    local bin_repo=/home/"$USER"/bin

    git config --global user.name 'Karel Zimmer'
    git config --global user.email 'karel.zimmer@gmail.com'
    git config --global pull.ff only
    git config --global credential.helper store

    if [[ -d "$bin_repo" ]]; then
        cd "$bin_repo" || exit 1
        # Remove known line from output.
        git pull | sed '/Already up to date./d' | sed '/Already up-to-date./d'
    else
        git clone https://github.com/karelzimmer/bin.git "$bin_repo"
    fi
    printf '%s\n' '* pull repos (gitpull)...'
    "$bin_repo"/gitpull
}


###############################################################################
# Script
###############################################################################

function main {
    init_script
    check_input
    process_input
    term_script
}

main
