#!/usr/bin/bash
# shellcheck shell=bash source=kz_common.sh disable=SC2155
###############################################################################
# SPDX-FileComment: Download and install package kz
#
# SPDX-FileCopyrightText: Karel Zimmer <info@karelzimmer.nl>
# SPDX-License-Identifier: CC0-1.0
###############################################################################


###############################################################################
# Imports
###############################################################################

# On a server, $0 is reported as '-bash' (login shell), so remove '-'.
if ! source "$(dirname "$(realpath "${0/^-/}")")"/kz_common.sh 2> /dev/null
then
    declare KZ_COMMON_FILE=$(mktemp -t "kz_common-XXXXXXXXXX.sh")
    declare KZ_COMMON_GITHUB_URI='https://raw.githubusercontent.com/karel'
            KZ_COMMON_GITHUB_URI+='zimmer/kz-scripts/main/usr/bin/kz_common.sh'
    wget    --output-document="$KZ_COMMON_FILE" $KZ_COMMON_GITHUB_URI
    source  "$KZ_COMMON_FILE"
    rm      "$KZ_COMMON_FILE"
fi


###############################################################################
# Variables
###############################################################################

declare PROGRAM_NAME='kz-deb'
declare PROGRAM_DESC=$(gettext 'Download and install package kz')
declare DISPLAY_NAME=${PROGRAM_NAME/kz-/kz }

declare USAGE=$(eval_gettext "Usage: \$DISPLAY_NAME \$OPTIONS_USAGE")

declare HELP="$(eval_gettext "Usage: \$DISPLAY_NAME [OPTION...]")

$PROGRAM_DESC.

$(gettext 'Options:')
$OPTIONS_HELP"

declare KZ_DEB_LOCAL_FILE=''


###############################################################################
# Functions
###############################################################################

# This function handles the script options and arguments.
function check_input {
    local    PARSED=''
    local -i PARSED_RC=0

    PARSED=$(
        getopt  --alternative                       \
                --options       "$OPTIONS_SHORT"    \
                --longoptions   "$OPTIONS_LONG"     \
                --name          "$DISPLAY_NAME"     \
                --              "$@"
        ) || PARSED_RC=$?
    if [[ $PARSED_RC -ne $OK ]]
    then
        infomsg "$USAGE"
        exit $ERROR
    fi
    eval set -- "$PARSED"

    process_options   "$@"
    process_x_options "$@"
}


# This function handles the extra options and arguments.
function process_x_options {
    while true
    do
        case $1 in
            -- )
                shift
                break
                ;;
            * )
                shift
                ;;
        esac
    done

    if [[ -n $* ]]
    then
        TEXT="$DISPLAY_NAME: $*: $(gettext 'arguments are not allowed')
$USAGE"
        infomsg "$TEXT"
        exit $ERROR
    fi
}


# This function processes the script options and arguments.
function process_input {
    become_root_check || exit $OK
    check_on_ac_power
    download_package
    install_package
}



# This function downloads package kz.
function download_package {
    local KZ_DEB_SITE_FILE=kz_4.2.1_all.deb
    local KZ_DEB_SITE_URI='https://karelzimmer.nl/assets/kz-deb/'

    KZ_DEB_LOCAL_FILE=$(mktemp -t "$PROGRAM_NAME-XXXXXXXXXX.deb")
    chmod o+r "$KZ_DEB_LOCAL_FILE"
    wget    --output-document="$KZ_DEB_LOCAL_FILE" \
            "$KZ_DEB_SITE_URI/$KZ_DEB_SITE_FILE"
}


# This function installs package kz.
function install_package {
    local INSTALL_SUGGESTS=''

    if $DESKTOP_ENVIRONMENT
    then
        INSTALL_SUGGESTS='--install-suggests'
    fi
    check_package_manager
    sudo    DEBIAN_FRONTEND=noninteractive  \
            apt-get                         \
            reinstall                       \
            $INSTALL_SUGGESTS               \
            --yes                           \
            "$KZ_DEB_LOCAL_FILE"            || install_package_xz
    rm      "$KZ_DEB_LOCAL_FILE"
}


# This function installs repackaged kz (for Debian 11).
function install_package_xz {
    local kz_deb_local_file_xz=$(mktemp -ut "$PROGRAM_NAME-XXXXXXXXXX.deb")

    sudo    apt-get install --yes binutils zstd
    ar      -xv --output=/tmp "$KZ_DEB_LOCAL_FILE"
    zstd    --uncompress < /tmp/control.tar.zst |
    xz      --compress   > /tmp/control.tar.xz
    zstd    --uncompress < /tmp/data.tar.zst    |
    xz      --compress   > /tmp/data.tar.xz
    ar      -mcav sdsd                          \
            "$kz_deb_local_file_xz"             \
            /tmp/debian-binary                  \
            /tmp/control.tar.xz                 \
            /tmp/data.tar.xz
    sudo    DEBIAN_FRONTEND=noninteractive      \
            apt-get                             \
            reinstall                           \
            $INSTALL_SUGGESTS                   \
            --yes                               \
            "$kz_deb_local_file_xz"
    rm      /tmp/debian-binary                  \
            /tmp/control.tar.xz                 \
            /tmp/data.tar.xz                    \
            /tmp/control.tar.zst                \
            /tmp/data.tar.zst                   \
            "$kz_deb_local_file_xz"
}


# This function controls the termination of the script.
function term_script {
    TEXT=$(gettext "Package kz has been successfully installed.

Now follow the steps as described in the Checklist installation.

Checklist installation can be found on https://karelzimmer.nl/en, under \
Linux.")
    if $DESKTOP_ENVIRONMENT
    then
        TEXT+="

$(gettext "Type 'exit' to close this window.")"
    fi
    infomsg "\n$TEXT"
    logmsg "Delete deb files ($PROGRAM_NAME)..."
    rm --force --verbose deb deb.{1..99} |& $LOGCMD
    exit $OK
}


###############################################################################
# Main script
###############################################################################

function main {
    init_script "$@"
    check_input "$@"
    process_input
    term_script
}

main "$@"
