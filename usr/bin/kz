#!/usr/bin/bash
# shellcheck source=kz_common.sh disable=SC2155
###############################################################################
# Run command.
#
# Written by Karel Zimmer <info@karelzimmer.nl>, CC0 1.0 Universal
# <https://creativecommons.org/publicdomain/zero/1.0>, 2021-2024.
###############################################################################


###############################################################################
# Import
###############################################################################

source "$(dirname "$0")"/kz_common.sh


###############################################################################
# Constants
###############################################################################

readonly    PROGRAM_NAME='kz'
            PROGRAM_DESC=$(gettext 'Run command')
readonly    PROGRAM_DESC
readonly    DISPLAY_NAME=${PROGRAM_NAME/kz-/kz }

            USAGE=$(eval_gettext "Usage: \$DISPLAY_NAME COMMAND [ARGUMENT...]")
            USAGE+='\n'
            USAGE+=$(eval_gettext "   or: \$DISPLAY_NAME [-l|--list] \$OPTIONS\
_USAGE")
readonly    USAGE
            HELP=$(eval_gettext "Usage: \$DISPLAY_NAME COMMAND [ARGUMENT...]")
            HELP+='\n'
            HELP+=$(eval_gettext "   or: \$DISPLAY_NAME OPTION")
            HELP+='\n\n'
            HELP+="$PROGRAM_DESC."
            HELP+='\n\n'
            HELP+=$(gettext 'Options:')
            HELP+='\n'
            HELP+=$(gettext '  -l, --list     show available COMMANDs')
            HELP+='\n'
            HELP+=$OPTIONS_HELP
            HELP+='\n\n'
            HELP+=$(gettext 'Arguments:')
            HELP+='\n'
            HELP+=$(gettext '  COMMAND        execute COMMAND')
            HELP+='\n'
            HELP+=$(gettext '  ARGUMENT       ARGUMENTs for COMMAND')
readonly    HELP

readonly    PROGRAM_PATH=$MODULE_PATH


###############################################################################
# Variables
###############################################################################

declare     exec_program_name=''


###############################################################################
# Functions
###############################################################################

# This function handles the script options and arguments.
function check_input {
    # No getopt here like in all other scripts because any specified options in
    # ARGUMENT, with kz COMMAND ARGUMENT, are for COMMAND, not for kz.
    if [[ -z "$*" ]]; then
        text=$USAGE
        msg_info "$text"
        exit $ERROR
    fi
    case $1 in
        -h*|--h*)
            process_option_help
            exit $OK
            ;;
        -u*|--u*)
            process_option_usage
            exit $OK
            ;;
        -v*|--v*)
            process_option_version
            exit $OK
            ;;
        -l*|--l*)
            process_option_list
            exit $OK
            ;;
        -*)
            text="$DISPLAY_NAME: $(gettext 'invalid option'): $1"
            text+='\n'
            text+=$USAGE_LINE
            msg_info "$text"
            exit $ERROR
            ;;
        *)
            exec_program_name=$1
            ;;
    esac
    if ! [[ -f "$PROGRAM_PATH/kz-$exec_program_name" ]]; then
        text="$DISPLAY_NAME: $exec_program_name: "
        text+=$(gettext "command does not exist")
        text+='\n'
        text+=$USAGE_LINE
        msg_info "$text"
        exit $ERROR
    fi
}


# This function displays all available commands.
function process_option_list {
        text=$(gettext 'The following COMMANDs are available:')
        text+='\n\n'
        text+=$(gettext 'NUM  COMMAND')
        msg_info "$text"
    find    "$PROGRAM_PATH"/kz-*    \
            -maxdepth 1             \
            -type f                 \
            -executable             \
            -readable               \
            -not -name '*~'         \
            -not -name 'kz'         \
            -printf '%f\n'          |
    sort                            |
    sed     --expression='s/kz-//'  |
    nl      --number-width=3        \
            --number-format=rn      \
            --number-separator='  ' \
            --body-numbering=a
    text='\n'
    text+=$(eval_gettext "To execute a COMMAND: \$BLUE\$DISPLAY_NAME COMMAND [\
ARGUMENT...]\$NORMAL")
    msg_info "$text"
}


# This function processes the script options and arguments.
function process_input {
    shift
    exec "$PROGRAM_PATH/kz-$exec_program_name" "$@"
}


# This function controls the termination of the script.
function term_script {
    exit $OK
}


###############################################################################
# Main Script
###############################################################################

function main {
    init_script "$@"
    check_input "$@"
    process_input "$@"
    term_script
}

main "$@"
