#!/usr/bin/bash
# shellcheck source=kz_common.sh disable=SC2155
###############################################################################
# SPDX-FileComment: Build package kz
#
# SPDX-FileCopyrightText: Karel Zimmer <info@karelzimmer.nl>
# SPDX-License-Identifier: CC0-1.0
###############################################################################


###############################################################################
# Imports
###############################################################################

source "$(dirname "$(realpath "$0")")"/kz_common.sh


###############################################################################
# Variables
###############################################################################

declare PROGRAM_NAME='kz-build'
declare PROGRAM_DESC=$(gettext 'Build package kz')
declare DISPLAY_NAME=${PROGRAM_NAME/kz-/kz }

declare USAGE=$(eval_gettext "Usage: \$DISPLAY_NAME \$OPTIONS_USAGE")

declare HELP="$(eval_gettext "Usage: \$DISPLAY_NAME [OPTION...]")

$PROGRAM_DESC.

$(gettext 'Options:')
$OPTIONS_HELP"

declare DOCS_REPO=$HOME/kz-docs
declare BIN_REPO=$HOME/bin
declare SCRIPTS_REPO=$HOME/kz-scripts

declare DEB_REPO=$HOME/kz-deb
declare DEB_REPO_APPDIR=$DEB_REPO/src
declare DEB_REPO_DISTDIR=$DEB_REPO/dist
declare DEB_NAME=kz_4.2.1_all.deb

declare UPLOADS_REPO=$HOME/kz-uploads
declare UPLOADS_REPO_APPDIR=$UPLOADS_REPO/src
declare UPLOADS_REPO_DISTDIR=$UPLOADS_REPO/dist

declare -A UPLOADS_SOURCES=(
            [kz-docs]=$DOCS_REPO
            )
declare -A UPLOADS_TARGETS=(
            [kz-docs]=$UPLOADS_REPO_DISTDIR/assets/kz-docs
                [deb]=$UPLOADS_REPO_DISTDIR/assets/kz-deb
            )

declare -A DEB_SOURCES=(
            [kz-scripts]=$SCRIPTS_REPO
                   [src]=$DEB_REPO_APPDIR
            )
declare -A DEB_TARGETS=(
              [dist]=$DEB_REPO_DISTDIR
             [build]=$DEB_REPO_DISTDIR/etc
            [man_en]=$DEB_REPO_DISTDIR/usr/share/man/man1
            [man_nl]=$DEB_REPO_DISTDIR/usr/share/man/nl/man1
            )

declare ERROR_FLAG=false


###############################################################################
# Functions
###############################################################################

# This function handles the script options and arguments.
function check_input {
    local    PARSED=''
    local -i PARSED_RC=0

    PARSED=$(
        getopt  --alternative                       \
                --options       "$OPTIONS_SHORT"    \
                --longoptions   "$OPTIONS_LONG"     \
                --name          "$DISPLAY_NAME"     \
                --              "$@"
        ) || PARSED_RC=$?
    if [[ $PARSED_RC -ne $OK ]]
    then
        infomsg "$USAGE"
        exit $ERROR
    fi
    eval set -- "$PARSED"

    process_options   "$@"
    process_x_options "$@"
}


# This function handles the extra options and arguments.
function process_x_options {
    while true
    do
        case $1 in
            -- )
                shift
                break
                ;;
            * )
                shift
                ;;
        esac
    done

    if [[ -n $* ]]
    then
        TEXT="$DISPLAY_NAME: $*: $(gettext 'arguments are not allowed')
$USAGE"
        infomsg "$TEXT"
        exit $ERROR
    fi

    if ! $DESKTOP_ENVIRONMENT
    then
        TEXT="$DISPLAY_NAME: $(gettext 'no desktop environment available')
$USAGE"
        infomsg "$TEXT"
        exit $ERROR
    fi
}


# This function processes the script options and arguments.
function process_input {
    become_root_check || exit $OK
    report_repos
    check_scripts
    build_uploads
    generate_mo
    build_deb
    install_package
    check_website
}


# This function reports repos which are not in the desired state.
function report_repos {
    local REPO=''

    TEXT=$(gettext 'Show repos not on branch main')...
    infomsg "$TEXT"
    for REPO in $DEB_REPO $DOCS_REPO $SCRIPTS_REPO $UPLOADS_REPO
    do
        cd "$REPO"
        if [[ $(git branch --show-current) != 'main' ]]
        then
            TEXT=$(eval_gettext "Repo \$REPO not on branch main.")
            infomsg "$TEXT"
        fi
    done
    TEXT=$(gettext 'Show repos which are not clean')...
    infomsg "$TEXT"
    for REPO in $DEB_REPO $DOCS_REPO $SCRIPTS_REPO $UPLOADS_REPO
    do
        cd "$REPO"
        # Prevent false positives.
        git status |& $LOGCMD
        if ! git diff-index --quiet HEAD
        then
            TEXT=$(eval_gettext "Repo \$REPO is not clean.")
            infomsg "$TEXT"
            git status
        fi
    done
}


# This function check the scripts.
function check_scripts {
    TEXT=$(gettext 'Check scripts')...
    infomsg "$TEXT"
    # Call kz check.
    logmsg 'Calling kz check...'
    "$SCRIPTS_REPO"/usr/bin/kz check || ERROR_FLAG=true
    logmsg 'Called kz check.'
}


# This function builds the website.
function build_uploads {
    local FILE=''
    local FILENAME=''

    TEXT=$(gettext 'Build website')...
    infomsg "$TEXT"

    # Make sure the permissions are correct for the sync.
    chmod --verbose 'u=rwx,g=rx,o=rx' -- "$SCRIPTS_REPO"/usr/bin/*  |& $LOGCMD
    chmod --verbose 'a-x' -- "$SCRIPTS_REPO"/usr/bin/*.*            |& $LOGCMD

    # Populate kz-uploads/dist/ with modified files in kz-uploads/src/.
    rsync   --archive               \
            --verbose               \
            --checksum              \
            "$UPLOADS_REPO_APPDIR"/ \
            "$UPLOADS_REPO_DISTDIR" |& $LOGCMD

    # Make sure all necessary directories are available.
    for dir in "${UPLOADS_TARGETS[@]}"
    do
        mkdir --parents "$dir" |& $LOGCMD
    done

    # Populate kz-uploads/dist/ with a PDF of modified files in repo kz-docs.
    cd "${UPLOADS_SOURCES[kz-docs]}"
    for FILE in *.odt *.txt
    do
        FILENAME=${FILE%.*}
        if [[ $FILE -nt ${UPLOADS_TARGETS[kz-docs]}/$FILENAME.pdf ]]
        then
            lowriter    --headless                              \
                        --convert-to pdf                        \
                        --outdir "${UPLOADS_TARGETS[kz-docs]}"  \
                        "$FILE"
        fi
    done
    cd "$HOME"
}


# This function generates the gettext binary Machine Object (.mo) file from the
# readable Portable Object (.po) file.
function generate_mo {
    local lc_messages=''

    lc_messages="$HOME"/kz-scripts/usr/share/locale/nl/LC_MESSAGES
    TEXT=$(gettext 'Generate .mo file')...
    infomsg "$TEXT"
    msgfmt --output-file="$lc_messages"/kz.mo  "$lc_messages"/kz.po
}


# This function builds package kz.
function build_deb {
    local BUILD_ID=''

    TEXT=$(gettext 'Build package')...
    infomsg "$TEXT"

    # Fill kz-deb/dist/ with kz-deb/src/.
    rsync   --archive               \
            --delete                \
            --verbose               \
            --exclude='README.md'   \
            --exclude='.git*'       \
            --delete-excluded       \
            "${DEB_SOURCES[src]}"/  \
            "${DEB_TARGETS[dist]}"  |& $LOGCMD

    # Fill kz-deb/dist/ with repo kz-scripts.
    rsync   --archive                       \
            --verbose                       \
            --exclude='__pycache__'         \
            --exclude='LICENSE'             \
            --exclude='README.md'           \
            --exclude='.git*'               \
            --exclude='kz.po'               \
            --exclude='kz.pot'              \
            "${DEB_SOURCES[kz-scripts]}"/   \
            "${DEB_TARGETS[dist]}"          |& $LOGCMD

    # Compress man pages.
    gzip    --best                      \
            --force                     \
            "${DEB_TARGETS[man_en]}"/*  \
            "${DEB_TARGETS[man_nl]}"/*  |& $LOGCMD

    # Capture build id Debian package.
    BUILD_ID=$(date '+%Y-%m-%dT%H:%M')
    mkdir --parents "${DEB_TARGETS[build]}" |& $LOGCMD
    printf '%s' "$BUILD_ID" > "${DEB_TARGETS[build]}"/$PROGRAM_NAME.id

    # Create Debian package in kz-uploads.
    fakeroot    dpkg-deb                            \
                --build                             \
                "$DEB_REPO_DISTDIR"                 \
                "${UPLOADS_TARGETS[deb]}/$DEB_NAME" |& $LOGCMD
}


# This function installs package kz.
function install_package {
    TEXT=$(gettext 'Install package')...
    infomsg "$TEXT"
    check_on_ac_power
    check_package_manager
    sudo    DEBIAN_FRONTEND=noninteractive  \
            apt-get                         \
            reinstall                       \
            --yes                           \
            "${UPLOADS_TARGETS[deb]}/$DEB_NAME"
}


# This function checks the website for missing or not used files.
function check_website {
    TEXT=$(gettext 'Check website')...
    infomsg "$TEXT"
    # Call rchecklink.
    logmsg 'Calling rchecklink...'
    "$BIN_REPO"/rchecklink || ERROR_FLAG=true
    logmsg 'Called rchecklink.'
}


# This function controls the termination of the script.
function term_script {
    if $ERROR_FLAG
    then
        TEXT=$(gettext 'Fix all the messages above.')
        errormsg "$TEXT"
        exit $ERROR
    else
        TEXT="${GREEN}$DISPLAY_NAME $(gettext 'finished')$NORMAL"
        infomsg "$TEXT"
        exit $OK
    fi
}


###############################################################################
# Main script
###############################################################################

function main {
    init_script "$@"
    check_input "$@"
    process_input
    term_script
}

main "$@"
