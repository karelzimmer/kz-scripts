#!/bin/bash
# shellcheck source=kz_common.sh
###############################################################################
# Pakket kz bouwen.
#
# Geschreven in 2021 door Karel Zimmer <info@karelzimmer.nl>, Creative Commons
# Publiek Domein Verklaring <http://creativecommons.org/publicdomain/zero/1.0>.
###############################################################################

set -o errexit
program_path=$(cd "$(dirname "$(realpath "$0")")" && pwd)
source "$program_path"/kz_common.sh


###############################################################################
# Constants
###############################################################################

declare program_name='kz-build'
declare program_desc='Pakket kz bouwen'
declare display_name=${program_name/kz-/kz }

declare usage="Gebruik: $display_name $options_usage"
declare help="Gebruik: $display_name [OPTIE...]

$program_desc.

Opties:
$options_help"

declare docs_repo=$HOME/kz-docs
declare scripts_repo=$HOME/kz-scripts

declare deb_repo=$HOME/kz-deb
declare deb_appdir=$deb_repo/app
declare deb_distdir=$deb_repo/dist
declare deb_name=kz_365_all.deb

declare uploads_repo=$HOME/kz-uploads
declare uploads_appdir=$uploads_repo/app
declare uploads_distdir=$uploads_repo/dist

declare -A uploads_sources=(
                [app]=$uploads_appdir
               [docs]=$docs_repo
            [scripts]=$scripts_repo
            )
declare -A uploads_targets=(
               [dist]=$uploads_distdir
                [deb]=$uploads_distdir/downloads/kz
               [docs]=$uploads_distdir/data/linux/documents
               [pdfs]=$uploads_distdir/data/linux/pdfs
            [scripts]=$uploads_distdir/data/linux/scripts
            )

declare -A deb_sources=(
                [app]=$deb_appdir
               [docs]=$docs_repo
            [scripts]=$scripts_repo
            )
declare -A deb_targets=(
               [dist]=$deb_distdir
              [build]=$deb_distdir/usr/local/etc
       [applications]=$deb_distdir/usr/share/applications
                [bin]=$deb_distdir/usr/bin
                [man]=$deb_distdir/usr/share/man/man1
           [policy_1]=$deb_distdir/usr/share/polkit-1/actions
           [tabcompl]=$deb_distdir/usr/share/bash-completion/completions
    )


###############################################################################
# Variables
###############################################################################


###############################################################################
# Functions
###############################################################################

function check_input {
    local -i getopt_rc=0
    local parsed=''

    parsed=$(
        getopt  --alternative                       \
                --options       "$options_short"    \
                --longoptions   "$options_long"     \
                --name          "$display_name"     \
                --              "$@"
        ) || getopt_rc=$?
    if [[ $getopt_rc -ne $ok ]]; then
        info "$usage_line"
        exit $err
    fi
    eval set -- "$parsed"
    kz_common.process_options "$@"

    while true; do
        case $1 in
            --)
                shift
                break
                ;;
            *)
                shift
                ;;
        esac
    done

    if [[ "$*" ]]; then
        printf  "$display_name: %s: %s\n$usage_line\n" \
                "$*" 'argumenten zijn niet toegestaan'
        exit $err
    fi

    # Aangemeld als ontwikkelaar?
    if ! kz_common.developer check; then
        kz_common.developer report
        exit $err
    fi
}


function process_input {
    # Er is een afhankelijkheid met het maken van PDF's, vandaar uploads eerst.
    build_uploads
    build_deb
}


function build_uploads {
    local file=''
    local temptextfile=''

    log 'Bouw website...'

    # Zorg dat de rechten goed staan voor de sync.
    chmod 'u=rwx,g=rx,o=rx' -- "$scripts_repo"/*
    chmod 'a-x' -- "$scripts_repo"/*.* "$scripts_repo"/LICENSE

    # Zorg ervoor dat alle benodigde mappen beschikbaar zijn voor de sync.
    for dir in "${uploads_targets[@]}"; do
        mkdir --parents "$dir" |& $logcmd
    done

    # Vul repo kz-uploads/dist/ met gewijzigde bestanden in repo
    # kz-uploads/app/.
    mkdir --parents "$uploads_distdir"
    rsync   --archive           \
            --verbose           \
            --checksum          \
            "$uploads_appdir"/  \
            "$uploads_distdir"  |& $logcmd

    # Vul repo kz-uploads/dist/ met gewijzigde bestanden in repo kz-docs, en
    # maak een PDF aan van gewijzigde bestanden.  Gebruik diff i.p.v. 'rsync
    # --checksum' omdat na kopiëren een PDF-bestand aangemaakt moet worden.
    mkdir --parents "${uploads_targets[docs]}"
    cd "${uploads_sources[docs]}"
    for file in *.odt *.txt; do
        if ! diff "$file" "${uploads_targets[docs]}/$file" |& $logcmd; then
            cp  --preserve                  \
                --verbose                   \
                "$file"                     \
                "${uploads_targets[docs]}"  |& $logcmd
            lowriter    --headless                          \
                        --convert-to pdf                    \
                        --outdir "${uploads_targets[pdfs]}" \
                        "$file"                             |& $logcmd
        fi
    done
    cd "$HOME"

    # Vul kz-uploads/dist/ met gewijzigde bestanden in repo kz-scripts, en
    # maak een PDF aan van gewijzigde bestanden.  Gebruik diff i.p.v. 'rsync
    # --checksum' omdat na kopiëren een PDF-bestand aangemaakt moet worden.
    mkdir --parents "${uploads_targets[scripts]}" "${uploads_targets[pdfs]}"
    cd "${uploads_sources[scripts]}"
    for file in kz*; do
        if ! diff "$file" "${uploads_targets[scripts]}/$file" |& $logcmd; then
            cp  --preserve                      \
                --verbose                       \
                "$file"                         \
                "${uploads_targets[scripts]}"   |& $logcmd
            if grep --quiet --regexp='^''.TH ' "$file"; then
                # Man-page.
                man --troff "${uploads_sources[scripts]}/$file"  |
                ps2pdf - "${uploads_targets[pdfs]}/$file.pdf"    |& $logcmd
            else
                # Script, *.completion, *.desktop, *.policy, and *.sh files.
                # Must copy each file with suffix e.g. .txt added
                # (temptextfile) before converting because:
                # 1. desktop-files have XML inside which gets interpreted by
                #    Libre Office,
                # 2. 'lowriter convert-to pdf' replaces last suffix (if any) by
                #    .pdf.
                temptextfile=/tmp/$file.txt
                cp "$file" "$temptextfile"
                lowriter    --headless                          \
                            --convert-to pdf                    \
                            --outdir "${uploads_targets[pdfs]}" \
                            "$temptextfile"                     |& $logcmd
                rm "$temptextfile"
            fi
        fi
    done
    cd "$HOME"
}


function build_deb {
    local basename=''
    local dir=''
    local file=''
    local newfile=''
    local prefix='nl.karelzimmer.'

    log 'Bouw pakket...'

    rsync   --archive               \
            --delete                \
            --verbose               \
            --exclude='README.md'   \
            --exclude='.git*'       \
            --delete-excluded       \
            "${deb_sources[app]}"/  \
            "${deb_targets[dist]}"  |& $logcmd

    # Zorg ervoor dat alle benodigde mappen beschikbaar zijn voor de sync.
    for dir in "${deb_targets[@]}"; do
        mkdir --parents "$dir" |& $logcmd
    done

    # Deze rsync is inclusief *.1, *.completion, *.desktop, en *.policy.
    rsync   --archive                   \
            --delete                    \
            --verbose                   \
            --exclude='__pycache__'     \
            --exclude='LICENSE'         \
            --exclude='README.md'       \
            --exclude='.git*'           \
            --delete-excluded           \
            "${deb_sources[scripts]}"/  \
            "${deb_targets[bin]}"       |& $logcmd

    # Man-pagina's (.1)
    rsync   --archive                   \
            --delete                    \
            --verbose                   \
            --remove-source-files       \
            "${deb_targets[bin]}"/*.1   \
            "${deb_targets[man]}"       |& $logcmd
    gzip --best --force "${deb_targets[man]}"/*.1 |& $logcmd

    # Tab-completion-scripts (.completion)
    for file in "${deb_targets[bin]}"/*.completion; do
        basename=$(basename "$file" .completion)
        mv "$file" "${deb_targets[tabcompl]}/$basename" |& $logcmd
    done

    # Bureaublad-configuratiebestanden (.desktop)
    for file in "${deb_targets[bin]}"/*.desktop; do
        basename=$(basename "$file")
        mv "$file" "${deb_targets[applications]}/$basename" |& $logcmd
    done

    # PolicyKit actiedefinitiebestanden (.policy)
    for file in "${deb_targets[bin]}"/*.policy; do
        basename=$(basename "$file")
        newfile="${deb_targets[policy_1]}/$prefix$basename"
        mv "$file" "$newfile" |& $logcmd
    done

    printf '%s' "$(date +%Y-%m-%d)" > "${deb_targets[build]}/$program_name"-id

    mkdir --parents "${uploads_targets[deb]}" |& $logcmd
    # Debian 11 does not support zst compression (default), hence the -Zxz.
    fakeroot    dpkg-deb                            \
                --build                             \
                -Zxz                                \
                "$deb_distdir"                      \
                "${uploads_targets[deb]}/$deb_name" |& $logcmd
}


function term_script {
    exit $ok
}


###############################################################################
# Script
###############################################################################

function main {
    kz_common.init_script "$@"
    check_input "$@"
    process_input
    term_script
}

main "$@"
