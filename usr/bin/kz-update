#!/usr/bin/env python3
"""
Update system.

This module performs a repair, update, and cleanup.
"""
###############################################################################
# Update system.
#
# This script updates the system.
# Use 'man kz update' for more information.
#
# Written by Karel Zimmer <info@karelzimmer.nl>, CC0 1.0 Universal
# <https://creativecommons.org/publicdomain/zero/1.0>, 2021-2023.
###############################################################################

###############################################################################
# Import
###############################################################################

import gettext
import kz_common
import subprocess
import sys

gettext.bindtextdomain('kz', '/usr/share/locale')
gettext.textdomain('kz')
_ = gettext.gettext


###############################################################################
# Constants
###############################################################################

PROGRAM_NAME = 'kz-update'
PROGRAM_DESC = (_('Update system'))
DISPLAY_NAME = PROGRAM_NAME.replace('kz-', 'kz ')


###############################################################################
# Variables
###############################################################################

command = ''
text = ''


###############################################################################
# Functions
###############################################################################

def perform_repair():
    """
    This function runs a repair of Debian packages.
    """
    text = _('Repair')
    print(f'{kz_common.BOLD}{text}{kz_common.NORMAL} ({PROGRAM_NAME})')
    exit
    command = 'dpkg --configure --pending'
    perform_command(command)

    command = 'apt-get update --fix-missing'
    perform_command(command)

    command = 'apt-get install --fix-broken'
    perform_command(command)


def perform_update():
    """
    This function updates installed Debian packages.
    """
    text = _('Update')
    print(f'{kz_common.BOLD}{text}{kz_common.NORMAL} ({PROGRAM_NAME})')
    command = 'apt-get update'
    perform_command(command)

    command = 'apt-get upgrade --yes'
    perform_command(command)

    snap_refresh()


def perform_command(command):
    """
    This function executes a command.
    """
    print(f'{command}...')
    kz_common.check_for_active_updates()
    try:
        subprocess.run(f'sudo {command}', shell=True, check=True)
    except Exception as exc:
        text = str(exc)
        kz_common.msg_log(PROGRAM_NAME, text)
        text = _('Program {} encountered an error.').format(PROGRAM_NAME)
        kz_common.msg_error(PROGRAM_NAME, text)
        sys.exit(kz_common.error)
    else:
        print()


def snap_refresh():
    """
    This function refreshes installed snaps.
    """
    print(_('Snap refresh...'))
    kz_common.check_for_active_updates()
    try:
        subprocess.run('sudo snap refresh', shell=True, check=True)
    except Exception as exc:
        text = str(exc)
        kz_common.msg_log(PROGRAM_NAME, text)
    else:
        print()


def perform_cleanup():
    """
    This function performs a Debian package cleanup.
    """
    text = _('Cleanup')
    print(f'{kz_common.BOLD}{text}{kz_common.NORMAL} ({PROGRAM_NAME})')
    command = 'apt-get autoclean --yes'
    perform_command(command)

    command = 'apt-get autoremove --yes'
    perform_command(command)

    snap_cleanup()


def snap_cleanup():
    """
    This function performs a snaps cleanup.
    """
    # Start with LANG=en_US.UTF-8 and check for disabled does not always work.
    cmd = '\
snap list --all | \
while read name ver rev trk pub notes; do \
    if [[ $notes == *uitgeschakeld* || $notes == *disabled* ]]; then \
        sudo snap remove "$name" --revision="$rev"; \
    fi \
done'

    print(_('Snap cleanup...'))
    try:
        subprocess.run({cmd}, shell=True, check=True, executable='/bin/bash')
    except Exception as exc:
        text = str(exc)
        kz_common.msg_log(PROGRAM_NAME, text)


def check_reboot():
    """
    This function checks if reboot is needed.
    """
    try:
        with open('/var/run/reboot-required') as fh:
            print('\n' + _('*** The computer must restart to complete the '
                           'installation of updates ***'))
    except FileNotFoundError as fnf:
        text = str(fnf)
        kz_common.msg_log(PROGRAM_NAME, text)
        text = _('Finished')
        print(f'{kz_common.GREEN}{text}.{kz_common.NORMAL}')
    except Exception as exc:
        text = str(exc)
        kz_common.msg_log(PROGRAM_NAME, text)
        text = _('Program {} encountered an error.').format(PROGRAM_NAME)
        kz_common.msg_error(PROGRAM_NAME, text)
        sys.exit(kz_common.error)


###############################################################################
# Main Script
###############################################################################

kz_common.process_options(PROGRAM_NAME, PROGRAM_DESC, DISPLAY_NAME)

kz_common.check_on_ac_power(PROGRAM_NAME)

kz_common.check_user_root(PROGRAM_NAME, DISPLAY_NAME)

perform_repair()

perform_update()

perform_cleanup()

check_reboot()
