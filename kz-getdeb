#!/usr/bin/bash
# shellcheck source=kz-common.sh
###############################################################################
# Pakket kz installeren.                                                      #
#                                                                             #
# Geschreven door Karel Zimmer <info@karelzimmer.nl>.                         #
###############################################################################

PROGRAM_PATH=$(realpath "$(dirname  "$0")")
if [[ -e "$PROGRAM_PATH"/kz-common.sh ]]; then
    source "$PROGRAM_PATH"/kz-common.sh
else
    wget    --no-verbose                                            \
            --output-document=/tmp/kz-common.sh                     \
            https://karelzimmer.nl/data/linux/scripts/kz-common.sh  &>/dev/null
    source /tmp/kz-common.sh
fi
PROGRAM_NAME=kz-getdeb
DISPLAY_NAME=${PROGRAM_NAME/kz-/kz }
RELEASE_YEAR=2016


###############################################################################
# Global constants                                                            #
###############################################################################

readonly OPTIONS_SHORT=$OPTIONS_SHORT_COMMON
readonly OPTIONS_LONG=$OPTIONS_LONG_COMMON
readonly USAGE="Gebruik: $DISPLAY_NAME $OPTIONS_USAGE_COMMON
     of: wget karelzimmer.nl/kz
         bash kz
     of: wget karelzimmer.nl/kz; bash kz
     of: wget -O- karelzimmer.nl/kz | bash
     of: curl -L karelzimmer.nl/kz | bash
     of: zoek naar get en klik op Scripts installeren"
readonly HELP="Gebruik: $DISPLAY_NAME [OPTIE...]
     of: wget karelzimmer.nl/kz
         bash kz
     of: wget karelzimmer.nl/kz; bash kz
     of: wget -O- karelzimmer.nl/kz | bash
     of: curl -L karelzimmer.nl/kz | bash
     of: zoek naar get en klik op Scripts installeren

Pakket kz installeren.

Opties:
$OPTIONS_HELP_COMMON"

readonly BIN_REPO=$HOME/bin
readonly WORK_REPO=$HOME/work
readonly DEB_REPO=$HOME/kz-deb
readonly DOCS_REPO=$HOME/kz-docs
readonly SCRIPTS_REPO=$HOME/kz-scripts
readonly UPLOADS_REPO=$HOME/kz-uploads
readonly UPLOADS_DISTDIR=$UPLOADS_REPO/dist


###############################################################################
# Global variables                                                            #
###############################################################################
declare DESKTOP_TERMINAL=false


###############################################################################
# Functions                                                                   #
###############################################################################

function check_input {
    local   -i  getopt_rc=0
    local       parsed=''

    parsed=$(
        getopt  --alternative                       \
                --options       "$OPTIONS_SHORT"    \
                --longoptions   "$OPTIONS_LONG"     \
                --name          "$DISPLAY_NAME"     \
                --              "$@"
        )       || getopt_rc=$?
    if [[ $getopt_rc -ne $SUCCESS ]]; then
        printf '%s\n' "$USAGELINE" >&2
        exit $ERROR
    fi
    eval set -- "$parsed"
    process_common_options "$@"

    while true; do
        case $1 in
            --)
                shift
                break
                ;;
            *)
                shift
                ;;
        esac
    done

    if [[ "$*" ]]; then
        TEXT='geen argumenten opgeven'
        printf "$DISPLAY_NAME: %s\n%s\n" "$TEXT" "$USAGELINE" >&2
        exit $ERROR
    fi

    # Een non-gui script gestart met optie gui.
    if $OPTION_GUI; then
        OPTION_GUI=false
        DESKTOP_TERMINAL=true
    fi

    clear -x
    check_user
    check_on_ac_power
}


function check_on_ac_power {
    local -i on_battery=0

    on_ac_power &> /dev/null || on_battery=$?
    if [[ $on_battery -eq 1 ]]; then
        TEXT='De computer gebruikt nu alleen de accu voor de stroomvoorziening.

Geadviseerd wordt om de computer aan te sluiten op het stopcontact.'
        whiptail    --backtitle "$DISPLAY_NAME" \
                    --title     'Waarschuwing'  \
                    --msgbox    "$TEXT"         \
                    10 71
    fi
}


function check_sudo_and_dpkg {
    check_sudo
    check_dpkg
}


function check_sudo {
    if ! sudo -n true 2> /dev/null; then
        while true; do
            TEXT='
Authenticatie is vereist voor het
installeren van pakket kz.

Voer uw wachtwoord in:'
            # Constructie '3>&1 1>&2 2>&3' om stdout en stderr te wisselen.
            if printf '%s\n' "$(
                whiptail    --backtitle     "$DISPLAY_NAME"         \
                            --title         'Authenticatie nodig'   \
                            --ok-button     'Verifiëren'            \
                            --cancel-button 'Annuleren'             \
                            --passwordbox   "$TEXT"                 \
                            12 37                                   \
                            3>&1 1>&2 2>&3
                )" | sudo --stdin true 2> /dev/null; then
                break
            else
                TEXT='Er is een fout opgetreden.

Mogelijke oorzaak:
1. Geen beheerder (kies <Stoppen>)
2. Geen of verkeerd wachtwoord ingevoerd
3. Op vorig scherm is <Annuleren> gekozen'
                if ! whiptail   --backtitle     "$DISPLAY_NAME" \
                                --title         'Fout'          \
                                --yes-button    'Opnieuw'       \
                                --no-button     'Stoppen'       \
                                --yesno         "$TEXT"         \
                                12 45; then
                    TEXT='Programma is gestopt door de gebruiker'
                    TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                                        --title     'Gestopt'       \
                                        --infobox   "$TEXT"         \
                                        7 42
                    exit        $SUCCESS
                fi
            fi
        done
    fi
}


function check_dpkg {
    local -i wait_for_aptd=5

    if ls /snap/core/*/var/cache/debconf/config.dat &> /dev/null; then
        while sudo  fuser                                                   \
                    /var/{lib/{dpkg,apt/lists},cache/apt/archives}/lock*    \
                    /var/cache/debconf/config.dat                           \
                    /snap/core/*/var/cache/debconf/config.dat               \
                    &> /dev/null; do
            TEXT="Wacht tot andere pakketbeheerder klaar is (kan even \
duren)..."
            TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                                --title     'Voortgang'     \
                                --infobox   "$TEXT"         \
                                7 65
            sleep $wait_for_aptd
        done
    else
        while sudo  fuser                                                   \
                    /var/{lib/{dpkg,apt/lists},cache/apt/archives}/lock*    \
                    /var/cache/debconf/config.dat                           \
                    &> /dev/null; do
            TEXT="Wacht tot andere pakketbeheerder klaar is (kan even \
duren)..."
            TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                                --title     'Voortgang'     \
                                --infobox   "$TEXT"         \
                                7 65
            sleep $wait_for_aptd
        done
    fi
}


function process_input {
    local full_name=''

    install_scriptspackage

    # Aangemeld als ontwikkelaar?
    full_name=$(
        getent  passwd  karel           |
        awk     -F':'   '{print $5}'    |
        awk     -F','   '{print $1}'    || true
        )
    if [[   $HOSTNAME == pc??                               &&
            ($USER = karel && $full_name = 'Karel Zimmer')  ]]; then
        create_development_environment
    fi
}


function install_scriptspackage {
    local site_deb=https://karelzimmer.nl/downloads/kz/kz_365_all.deb
    local temp_deb=''

    # Bij Live-sessie de universe repo aanzetten.
    if  [[ $HOSTNAME = 'ubuntu' && $USER = 'ubuntu' ]]; then
        check_sudo_and_dpkg
        TEXT='Voeg pakketbron toe...'
        TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                            --title     'Voortgang'     \
                            --infobox   "$TEXT"         \
                            7 26
        sudo add-apt-repository --yes universe  |& $LOGCMD

        check_sudo_and_dpkg
        TEXT='Ververs pakketlijst'
        TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                            --title     'Voortgang'     \
                            --infobox   "$TEXT"         \
                            7 23
        sudo apt-get update |& $LOGCMD
    fi

    # Installeer pakket.
    check_sudo_and_dpkg
    TEXT='Download pakket...'
    TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                        --title     'Voortgang'     \
                        --infobox   "$TEXT"         \
                        7 22

    temp_deb=$(mktemp -t "$PROGRAM_NAME-XXXXXXXXXX.deb")
    wget --no-verbose --output-document="$temp_deb" $site_deb |& $LOGCMD

    check_sudo_and_dpkg
    TEXT='Installeer pakket (kan even duren)...'
    TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                        --title     'Voortgang'     \
                        --infobox   "$TEXT"         \
                        7 41

    check_sudo_and_dpkg
    sudo    DEBIAN_FRONTEND=noninteractive  \
            apt-get                         \
            install                         \
            --yes                           \
            --reinstall                     \
            "$temp_deb"                     |& $LOGCMD
    rm "$temp_deb" |& $LOGCMD
}


function create_development_environment {
    TEXT='Maak ontwikkelomgeving...'
    TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                        --title     'Voortgang'     \
                        --infobox   "$TEXT"         \
                        7 29
    process_repos
    download_website
}


function process_repos {
    if ! command -v git 1> /dev/null; then
        sudo apt-get install --yes git |& $LOGCMD
    fi
    git config --global credential.helper store |& $LOGCMD
    if ! git    clone                                   \
                https://github.com/karelzimmer/bin.git  \
                "$BIN_REPO"                             |& $LOGCMD
    then
        cd "$BIN_REPO" || exit $ERROR
        git pull |& $LOGCMD
    fi
    if ! git    clone                                       \
                https://github.com/karelzimmer/work.git     \
                "$WORK_REPO"                                |& $LOGCMD
    then
        cd "$WORK_REPO" || exit $ERROR
        git pull |& $LOGCMD
    fi
    if ! git    clone                                       \
                https://github.com/karelzimmer/kz-deb.git   \
                "$DEB_REPO"                                 |& $LOGCMD
    then
        cd "$DEB_REPO" || exit $ERROR
        git pull |& $LOGCMD
    fi
    if ! git    clone                                       \
                https://github.com/karelzimmer/kz-docs.git  \
                "$DOCS_REPO"                                |& $LOGCMD
    then
        cd "$DOCS_REPO" || exit $ERROR
        git pull |& $LOGCMD
    fi
    if ! git    clone                                           \
                https://github.com/karelzimmer/kz-scripts.git   \
                "$SCRIPTS_REPO"                                 |& $LOGCMD
    then
        cd "$SCRIPTS_REPO" || exit $ERROR
        git pull |& $LOGCMD
    fi
    if ! git    clone                                           \
                https://github.com/karelzimmer/kz-uploads.git   \
                "$UPLOADS_REPO"                                 |& $LOGCMD
    then
        cd "$UPLOADS_REPO" || exit $ERROR
        git pull |& $LOGCMD
    fi
}


function download_website {
    local ftp_set='set ssl:verify-certificate no'
    local ftp_from=/httpdocs
    local ftp_to=$UPLOADS_DISTDIR
    local ftp_opts='--delete --verbose'
    local ftp_cmd="mirror $ftp_opts $ftp_from $ftp_to; exit"
    local ftp_host=server106.hosting2go.nl
    local ftp_user=kzimmer
    local ftp_login=$HOME/.kz-$ftp_host

    if ! command -v lftp 1> /dev/null; then
        sudo apt-get install --yes lftp |& $LOGCMD
    fi
    if ! [[ -f $ftp_login ]]; then
        # < /dev/tty want FD 1 al in gebruik bij 'wget -O- karelzim... | bash'.
        read -rsp "FTP-wachtwoord voor $ftp_host: " < /dev/tty
        printf '%s\n' "$REPLY" > "$ftp_login"
        printf '\n'
        chmod 'u=rw,g=,o=' "$ftp_login" |& $LOGCMD
    fi
    TEXT='Download website (kan even duren)...'
    TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                        --title     'Voortgang'     \
                        --infobox   "$TEXT"         \
                        7 40
    if ! lftp   --user "$ftp_user"                  \
                --password "$(cat "$ftp_login")"    \
                -e "$ftp_set; $ftp_cmd"             \
                "$ftp_host"                         |& $LOGCMD; then
        rm      "$ftp_login"
        warning 'Downloaden website is mislukt.'
        warning 'Controleer de log...!'
        return  $WARNING
    fi
}


function term_script {
    test -f "${XDG_CONFIG_HOME:-~/.config}"/user-dirs.dirs &&
        source "${XDG_CONFIG_HOME:-~/.config}"/user-dirs.dirs
    local docs_dir=${XDG_DOCUMENTS_DIR:-$HOME/Documenten}
    local search=''

    search="/usr/share/doc/kz/Checklist-installatie-$(
            lsb_release --id    \
                        --short
            )"
    cp  --update "$search"*{desktop,server}.pdf "$docs_dir" |& $LOGCMD || true
    cp  --update                                    \
        "$search"*{desktop,server}"-$HOSTNAME".pdf  \
        "$docs_dir"                                 |& $LOGCMD || true

    TEXT='Pakket kz is succesvol geïnstalleerd.

Volg nu de stappen zoals beschreven
in de Checklist installatie.

Deze checklist is te vinden:
- in de map Documenten
- in de map /usr/share/doc/kz
- op de site https://karelzimmer.nl,
  onder Linux'
    height=16

    if ! $DESKTOP_TERMINAL; then
        TEXT=$TEXT"

Typ 'exit' om dit venster te sluiten."
        height=18
    fi
    TERM=ansi whiptail  --backtitle "$DISPLAY_NAME" \
                        --title 'Gereed'            \
                        --infobox "$TEXT"           \
                        $height 41
    exit $SUCCESS
}


###############################################################################
# Main line                                                                   #
###############################################################################

function main {
    init_script "$@"
    check_input "$@"
    process_input
    term_script
}


main "$@"
