#!/bin/bash
###############################################################################
# Opdracht uitvoeren.
#
# Geschreven door Karel Zimmer <info@karelzimmer.nl>.
###############################################################################
PROGRAM_PATH=$(realpath "$(dirname  "$0")")
#source "$PROGRAM_PATH"/kz-common.sh
PROGRAM_NAME=kz
DISPLAY_NAME=${PROGRAM_NAME/kz-/kz }
RELEASE_YEAR=2021

VERSION_NUMBER=01.02.05
VERSION_DATE=2021-09-08


###############################################################################
# Global constants
###############################################################################

declare -ir SUCCESS=0
declare -ir ERROR=1
declare -ir WARNING=2
readonly    THIS_YEAR=$(date +%Y)

readonly    USAGE="\
Gebruik: $DISPLAY_NAME OPDRACHT [ARG]
     of: $DISPLAY_NAME [-l|--list] [-u|--usage] [-h|--help] [-v|--version]"
readonly    HELP="\
Gebruik: $DISPLAY_NAME OPDRACHT [ARG]
         $DISPLAY_NAME OPTIE

Opdracht uitvoeren.

Opties:
  -l --list     toon beschikbare OPDRACHTen
  -h --help     deze hulptekst tonen
  -u --usage    een korte gebruikssamenvatting tonen
  -v --version  de versie tonen

Argumenten:
  OPDRACHT      uit te voeren opdracht
  ARG           argumenten behorend bij OPDRACHT"


###############################################################################
# Global variables
###############################################################################


###############################################################################
# Functions
###############################################################################

init_script() {
    # Script-hardening.
    set -o errexit
    set -o errtrace
    set -o nounset
    set -o pipefail

    # Script kz-getdeb verwijdert niet kz en kz.1 i.v.m. lokale Git-repo.
    rm --force kz.{2..99}
}


check_input() {
    # Geen getopt, opgegeven opties zijn voor de opdracht, niet voor kz zelf.
    if ! [[ "$*" ]]; then
        printf '%s\n\n' "$USAGE" >&2
        show_commands
        exit $WARNING
    elif [[ $1 == *-u* ]]; then
        process_option_usage
        exit $SUCCESS
    elif [[ $1 == *-h* ]]; then
        process_option_help
        exit $SUCCESS
    elif [[ $1 == *-v* ]]; then
        process_option_version
        exit $SUCCESS
    elif [[ $1 == *-l* ]]; then
        show_commands
        exit $SUCCESS
    elif ! [[ -e "$PROGRAM_PATH/kz-$1" ]]; then
        printf "$DISPLAY_NAME: %s\n\n" "OPDRACHT '$1' bestaat niet" >&2
        show_commands
        exit $ERROR
    fi
}


show_commands() {
    printf '%s\n' 'De volgende OPDRACHTen zijn beschikbaar:'
    find    "$PROGRAM_PATH"/kz-*    \
            -maxdepth 1             \
            -type f                 \
            -executable             \
            -readable               \
            -not -name '*~'         \
            -not -name 'kz'         \
            -printf '%f\n'          |
    sort                            |
    sed     's/kz-//'
    printf '\n%s\n' "Typ '$DISPLAY_NAME --usage' voor meer informatie."
}


process_option_usage() {
    printf '%s\n\n%s\n' \
            "$USAGE"    \
            "Typ '$DISPLAY_NAME --help' voor meer informatie."
}


process_option_help() {
    printf  '%s\n\n%s\n'    \
            "$HELP"         \
            "Typ 'man $DISPLAY_NAME' voor meer informatie."
}


process_option_version() {
    local copyright_years='1970'

    if [[ $RELEASE_YEAR -eq $THIS_YEAR ]]; then
        copyright_years=$RELEASE_YEAR
    else
        copyright_years=$RELEASE_YEAR-$THIS_YEAR
    fi
    printf '%s\n' "$DISPLAY_NAME $VERSION_NUMBER ($VERSION_DATE)

Geschreven door Karel Zimmer <info@karelzimmer.nl>.

Auteursrecht (c) $copyright_years Karel Zimmer.
GNU Algemene Publieke Licentie <https://www.gnu.org/licenses/gpl.html>."
}


process_input() {
local program_name=''

    program_name=$1
    shift
    exec "$PROGRAM_PATH/kz-$program_name" "$@"
}


term_script() {
    exit $SUCCESS
}


###############################################################################
# Main line
###############################################################################

main() {
    init_script
    check_input "$@"
    process_input "$@"
    term_script
}


main "$@"


# EOF
