#!/bin/bash
###############################################################################
# Opdracht uitvoeren.
#
# Geschreven in 2021 door Karel Zimmer <info@karelzimmer.nl>, Creative Commons
# Publiek Domein Verklaring <http://creativecommons.org/publicdomain/zero/1.0>.
###############################################################################


###############################################################################
# Global constants
###############################################################################

readonly PROGRAM_NAME='kz'
readonly PROGRAM_DESC='Opdracht uitvoeren'
readonly DISPLAY_NAME=${PROGRAM_NAME/kz-/kz }

# Redhat reports $0 as '-bash', dirname "$0" -> dirname: invalid option -- 'b'.
PROGRAM_PATH=$(realpath "$(dirname  "${0/#-/}")")
readonly PROGRAM_PATH
source  "$PROGRAM_PATH"/kz_common.sh

readonly USAGE="Gebruik: $DISPLAY_NAME OPDRACHT [ARG]
     of: $DISPLAY_NAME [-l|--list] [-u|--usage] [-h|--help] [-v|--version]"
readonly HELP="Gebruik: $DISPLAY_NAME OPDRACHT [ARG]
     of: $DISPLAY_NAME OPTIE

$PROGRAM_DESC.

Opties:
  -l, --list     toon beschikbare OPDRACHTen
  -h, --help     toon deze hulptekst
  -u, --usage    toon een korte gebruikssamenvatting
  -v, --version  toon programmaversie

Argumenten:
  OPDRACHT       uit te voeren opdracht
  ARG            argumenten behorend bij OPDRACHT"


###############################################################################
# Global variables
###############################################################################


###############################################################################
# Functions
###############################################################################

function check-input {
    # Geen getopt want opgegeven opties zijn voor 'OPDRACHT', niet voor kz.
    if ! [[ "$*" ]]; then
        info "Verplicht argument 'OPDRACHT' ontbreekt."
        info "$USAGELINE"
        exit $ERR
    elif [[ $1 == *-u* ]]; then
        kz_common.process-option-usage
        exit $OK
    elif [[ $1 == *-h* ]]; then
        kz_common.process-option-help
        exit $OK
    elif [[ $1 == *-v* ]]; then
        kz_common.process-option-version
        exit $OK
    elif [[ $1 == *-l* ]]; then
        show-commands
        exit $OK
    elif ! [[ -f "$PROGRAM_PATH/kz-$1" ]]; then
        info "Opdracht '$1' bestaat niet."
        info "$USAGELINE"
        exit $ERR
    fi
}


function show-commands {
    info 'De volgende OPDRACHTen zijn beschikbaar:

     OPDRACHT'
    find    "$PROGRAM_PATH"/kz-*            \
            -maxdepth 1                     \
            -type f                         \
            -executable                     \
            -readable                       \
            -not -name '*~'                 \
            -not -name 'kz'                 \
            -printf '%f\n'                  |
    sort                                    |
    sed     --expression='s/kz-//'          |
            nl      --number-width=2        \
                    --number-format=rn      \
                    --number-separator='] ' \
                    --body-numbering=a      |
            sed     --expression='s/^/[/'
    info "
Om een OPDRACHT uit te voeren:
${BLUE}$DISPLAY_NAME OPDRACHT${NORMAL}"
}


function process-input {
    local program_name=''

    program_name=$1
    shift
    exec "$PROGRAM_PATH/kz-$program_name" "$@"
}


function term-script {
    exit $OK
}


###############################################################################
# Script
###############################################################################

function main {
    kz_common.init-script "$@"
    check-input "$@"
    process-input "$@"
    term-script
}

main "$@"
