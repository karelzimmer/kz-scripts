#!/usr/bin/python3
"""
Systeem bijwerken.

Dit script voert een update uit voor op Debian gebaseerde systemen.
"""
###############################################################################
# Systeem bijwerken.
#
# Geschreven door Karel Zimmer <info@karelzimmer.nl>.
###############################################################################

import kz_common
import subprocess
import sys

###############################################################################
# Global constants
###############################################################################

program_name = 'kz-update'
display_name = program_name.replace('kz-', 'kz ')
program_desc = 'Systeem bijwerken.'
release_year = 2021


###############################################################################
# Global variables
###############################################################################

apt_cmd = ''


###############################################################################
# Functions
###############################################################################

def check_sudo():
    subprocess.run('sudo true', shell=True, check=True)


def perform_apt_cmd(apt_cmd):
    subprocess.run(f'sudo apt-get {apt_cmd}', shell=True, check=True)


def snap_refresh():
    subprocess.run('sudo snap refresh', shell=True)


def check_reboot():
    try:
        with open('/var/run/reboot-required') as fh:
            print('\nDe computer moet herstarten om het installeren van '
                  'updates af te ronden.')
    except FileNotFoundError:
        pass
    except Exception as ex:
        print(ex)
        sys.exit(1)


###############################################################################
# Main
###############################################################################

kz_common.process_common_options(display_name, program_desc)

check_sudo()

print('Uitvoeren apt update...')
kz_common.check_dpkg()
apt_cmd = 'update'
perform_apt_cmd(apt_cmd)

print('\nUitvoeren apt upgrade...')
kz_common.check_dpkg()
apt_cmd = 'upgrade --yes'
perform_apt_cmd(apt_cmd)

print('\nUitvoeren apt autoremove...')
kz_common.check_dpkg()
apt_cmd = 'autoremove --yes'
perform_apt_cmd(apt_cmd)

print('\nUitvoeren snap refresh...')
snap_refresh()

check_reboot()
