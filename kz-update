#!/usr/bin/python3
"""
Systeem bijwerken.

Dit script voert een update uit voor Debian gebaseerde systemen.
"""
###############################################################################
# Systeem bijwerken.                                                          #
#                                                                             #
# Geschreven door Karel Zimmer <info@karelzimmer.nl>.                         #
###############################################################################

import sys
import kz_common
import subprocess


program_name = 'kz-update'
display_name = program_name.replace('kz-', 'kz ')
release_year = 2021
desc = 'Systeem bijwerken.'


def perform_cleanup():
    subprocess.run('sudo true', shell=True, check=True)
    print(f'Opschonen sleutels in /etc/apt/trusted.gpg...')
    # Chrome
    subprocess.run('sudo apt-key del 7FAC5991 D38B4796',
                   shell=True, check=True,
                   stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    subprocess.run('sudo rm --force /etc/apt/trusted.gpg.d/google-chrome*',
                   shell=True, check=True)
    # Earth
    subprocess.run('sudo apt-key del 7FAC5991 D38B4796',
                   shell=True, check=True,
                   stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    subprocess.run('sudo rm --force /etc/apt/trusted.gpg.d/google-earth*',
                   shell=True, check=True)
    # Signal
    subprocess.run('sudo apt-key del 57F6FB06',
                   shell=True, check=True,
                   stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    subprocess.run('sudo rm --force /etc/apt/trusted.gpg.d/signal*',
                   shell=True, check=True)
    # Teams
    subprocess.run('sudo apt-key del BE1229CF',
                   shell=True, check=True,
                   stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    subprocess.run('sudo rm --force /etc/apt/trusted.gpg.d/microsoft*',
                   shell=True, check=True)
    # TeamViewer
    subprocess.run('sudo apt-key del 0C1289C0 DEB49217',
                   shell=True, check=True,
                   stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    subprocess.run('sudo rm --force /etc/apt/trusted.gpg.d/teamviewer*',
                   shell=True, check=True)
    # VirtualBox
    subprocess.run('sudo apt-key del 98AB5139 2980AECF',
                   shell=True, check=True,
                   stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    subprocess.run('sudo rm --force /etc/apt/trusted.gpg.d/oracle_vbox*',
                   shell=True, check=True)
    # Webmin
    subprocess.run('sudo apt-key del 11F63C51',
                   shell=True, check=True,
                   stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    subprocess.run('sudo rm --force /etc/apt/trusted.gpg.d/webmin*',
                   shell=True, check=True)


def perform_update():
    # Opdracht als sequence.
    subprocess.run(['sudo', 'apt-get', 'update'])

    # Opdracht als raw text.
    subprocess.run('sudo apt-get upgrade --yes', shell=True)
    subprocess.run('sudo apt-get dist-upgrade --yes', shell=True)

    # Opdracht als raw text, vang afsluitwaarde op.
    subprocess.run('sudo rm --force /etc/apt/trusted.gpg.d/google-chrome*',
                   shell=True, check=True)
    subprocess.run('sudo apt-get autoremove --yes', shell=True, check=True)
    subprocess.run('sudo apt-get autoclean --yes', shell=True, check=True)

    # Heeft dit systeem snaps?
    try:
        subprocess.run('sudo snap refresh', shell=True)
    except Exception as ex:
        print(ex)

    # Is een reboot nodig?
    try:
        with open('/var/run/reboot-required') as fh:
            print(f'{display_name}: REBOOT')
    except FileNotFoundError:
        pass
    except Exception as ex:
        print(ex)
        sys.exit(1)


# --- script ---

kz_common.process_common_options(desc, display_name)

perform_cleanup()
perform_update()
